name: Release and Publish

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  id-token: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for changelog

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Get tag information
        id: tag
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          VERSION=${TAG_NAME#v}
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "RELEASE_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine setuptools-scm

      - name: Generate CHANGELOG.md for release
        run: |
          # Generate changelog from git commit history
          cat > CHANGELOG.md << 'EOF'
          # Changelog

          All notable changes are documented here.
          Generated from git commit history.

          EOF

          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          echo "## [${{ steps.tag.outputs.VERSION }}] - ${{ steps.tag.outputs.RELEASE_DATE }}" >> CHANGELOG.md
          echo "" >> CHANGELOG.md

          if [ -z "$PREV_TAG" ]; then
            echo "### Initial Release" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            git log --pretty=format:"- %s (%h)" --no-merges | head -30 >> CHANGELOG.md
          else
            # Categorize commits by type
            echo "### âœ¨ Features" >> CHANGELOG.md
            FEATURES=$(git log ${PREV_TAG}..HEAD --pretty=format:"%s" --no-merges | grep -E "^feat:" | sed 's/^feat: /- /' || true)
            if [ -z "$FEATURES" ]; then
              echo "_No new features_" >> CHANGELOG.md
            else
              echo "$FEATURES" >> CHANGELOG.md
            fi
            echo "" >> CHANGELOG.md
            
            echo "### ðŸ› Bug Fixes" >> CHANGELOG.md
            FIXES=$(git log ${PREV_TAG}..HEAD --pretty=format:"%s" --no-merges | grep -E "^fix:" | sed 's/^fix: /- /' || true)
            if [ -z "$FIXES" ]; then
              echo "_No bug fixes_" >> CHANGELOG.md
            else
              echo "$FIXES" >> CHANGELOG.md
            fi
            echo "" >> CHANGELOG.md
            
            echo "### ðŸ“š Documentation" >> CHANGELOG.md
            DOCS=$(git log ${PREV_TAG}..HEAD --pretty=format:"%s" --no-merges | grep -E "^docs:" | sed 's/^docs: /- /' || true)
            if [ -z "$DOCS" ]; then
              echo "_No documentation changes_" >> CHANGELOG.md
            else
              echo "$DOCS" >> CHANGELOG.md
            fi
            echo "" >> CHANGELOG.md
            
            echo "### ðŸ”§ Other Changes" >> CHANGELOG.md
            OTHERS=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s" --no-merges | grep -Ev "^- (feat:|fix:|docs:)" || true)
            if [ -z "$OTHERS" ]; then
              echo "_No other changes_" >> CHANGELOG.md
            else
              echo "$OTHERS" >> CHANGELOG.md
            fi
          fi

          echo "" >> CHANGELOG.md
          echo "---" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "**Full Changelog**: https://github.com/starthackHQ/Contextinator/compare/${PREV_TAG:-v0.0.96}...${{ steps.tag.outputs.TAG_NAME }}" >> CHANGELOG.md

          cat CHANGELOG.md

      - name: Build package
        run: |
          python -m build
          mkdir -p release
          cp dist/* release/

          # Copy CHANGELOG.md to release artifacts
          cp CHANGELOG.md release/

      - name: Create checksums
        run: |
          cd release
          sha256sum * > checksums.txt

      - name: Generate release notes from commits
        id: changelog
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          echo "## ðŸŽ‰ What's Changed" > release_notes.md
          echo "" >> release_notes.md

          if [ -z "$PREV_TAG" ]; then
            # First release
            echo "Initial release! ðŸš€" >> release_notes.md
            echo "" >> release_notes.md
            git log --pretty=format:"- %s (%h)" --no-merges | head -20 >> release_notes.md
          else
            # Get commits categorized by type
            echo "### âœ¨ Features" >> release_notes.md
            FEATURES=$(git log ${PREV_TAG}..HEAD --pretty=format:"%s" --no-merges | grep -E "^feat:" | sed 's/^feat: /- /' || true)
            if [ -z "$FEATURES" ]; then
              echo "- No new features" >> release_notes.md
            else
              echo "$FEATURES" >> release_notes.md
            fi
            echo "" >> release_notes.md
            
            echo "### ðŸ› Bug Fixes" >> release_notes.md
            FIXES=$(git log ${PREV_TAG}..HEAD --pretty=format:"%s" --no-merges | grep -E "^fix:" | sed 's/^fix: /- /' || true)
            if [ -z "$FIXES" ]; then
              echo "- No bug fixes" >> release_notes.md
            else
              echo "$FIXES" >> release_notes.md
            fi
            echo "" >> release_notes.md
            
            echo "### ðŸ“š Documentation" >> release_notes.md
            DOCS=$(git log ${PREV_TAG}..HEAD --pretty=format:"%s" --no-merges | grep -E "^docs:" | sed 's/^docs: /- /' || true)
            if [ -z "$DOCS" ]; then
              echo "- No documentation changes" >> release_notes.md
            else
              echo "$DOCS" >> release_notes.md
            fi
            echo "" >> release_notes.md
            
            echo "### ðŸ”§ Other Changes" >> release_notes.md
            OTHERS=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges | grep -Ev "^- (feat:|fix:|docs:)" || true)
            if [ -z "$OTHERS" ]; then
              echo "- No other changes" >> release_notes.md
            else
              echo "$OTHERS" >> release_notes.md
            fi
          fi

          echo "" >> release_notes.md
          echo "## ðŸ“¦ Installation" >> release_notes.md
          echo "" >> release_notes.md
          echo '```bash' >> release_notes.md
          echo "pip install contextinator==${{ steps.tag.outputs.VERSION }}" >> release_notes.md
          echo '```' >> release_notes.md
          echo "" >> release_notes.md
          echo "## ðŸ“– Documentation" >> release_notes.md
          echo "" >> release_notes.md
          echo "Visit [https://github.com/starthackHQ/Contextinator](https://github.com/starthackHQ/Contextinator) for full documentation." >> release_notes.md

          cat release_notes.md

      - name: Verify package
        run: twine check dist/*

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.TAG_NAME }}
          name: Release ${{ steps.tag.outputs.TAG_NAME }}
          draft: false
          prerelease: false
          files: release/*
          body_path: release_notes.md
          make_latest: true

      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: twine upload dist/*
